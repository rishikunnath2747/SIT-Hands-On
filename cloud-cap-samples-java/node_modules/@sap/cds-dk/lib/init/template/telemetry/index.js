const cds = require('../../../cds')
const { readProject } = require('../../projectReader')
const { merge, sort } = require('../../merge')

module.exports = class extends require('../../plugin') {

  static hasInProduction(env) {
    return !!env.requires?.telemetry || cds.cli.argv?.includes('telemetry') || !!cds.cli.options?.add?.telemetry
  }

  async canRun() {
    return true
  }

  requires() {
    return ['cloud-logging']
  }

  async run() {
    const project = readProject();
    project.profile ??= 'production'
    await merge(__dirname, 'files/package.json.hbs').into('package.json', { with: project })
    await sort('package.json', 'dependencies')
  }
}
