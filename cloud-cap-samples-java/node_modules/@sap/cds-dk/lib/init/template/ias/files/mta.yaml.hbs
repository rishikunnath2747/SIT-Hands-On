---
modules:
  - name: {{appName}}-srv
    type: {{language}}
    path: {{& srvPath}}
    requires:
      - name: {{appName}}-auth
        parameters:
          config:
            credential-type: X509_GENERATED
            app-identifier: srv
    parameters:
      routes:
        - route: "${default-url}"
        - route: "${default-host}.cert.${default-domain}"
    provides:
      - name: srv-api
        properties:
          srv-cert-url: '${protocol}://${default-host}.cert.${default-domain}'

  - name: {{appName}}
    type: approuter.nodejs
    path: app/router
    requires:
      - name: {{appName}}-auth
        parameters:
          config:
            credential-type: X509_GENERATED
            app-identifier: approuter
      - name: srv-api
        group: destinations
        properties:
          url: ~{srv-cert-url}
          forwardAuthCertificates:  true
          strictSSL: true

  - name: {{appName}}-mtx
    type: nodejs
    path: {{#isNodejs}}gen/{{/isNodejs}}mtx/sidecar
    requires:
      - name: {{appName}}-auth
        parameters:
          config:
            credential-type: X509_GENERATED
            app-identifier: mtx

resources:
  - name: {{appName}}-auth
    type: org.cloudfoundry.managed-service
    {{#hasApprouter}}
    requires:
      - name: app-api
    {{/hasApprouter}}
    parameters:
      service: identity
      service-name: {{appName}}-auth
      service-plan: application
      config:
        display-name: {{appName}}
        {{#hasApprouter}}
        oauth2-configuration:
          redirect-uris:
            - ~{app-api/app-protocol}://~{app-api/app-uri}/login/callback
          post-logout-redirect-uris:
            - ~{app-api/app-protocol}://~{app-api/app-uri}/*/logout.html
        {{/hasApprouter}}
        {{#hasAms}}
        authorization:
          enabled: true
        {{/hasAms}}
        {{#hasMultitenancy}}
        multi-tenant: true
        {{/hasMultitenancy}}
        {{#hasXsuaa}}
        xsuaa-cross-consumption: true
        {{/hasXsuaa}}
